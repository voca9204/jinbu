<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부암동 건축 점검 보고서 - 저장 상태 표시</title>
    
    <!-- Firebase v11.6.0 최신 Modular SDK -->
    <script type="module">
        // Firebase v11.6.0 Modular API 불러오기
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js';
        import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js';
        
        // Firebase 설정 (실제 프로젝트 연결됨)
        const firebaseConfig = {
            apiKey: "AIzaSyACCbVD7LT2istfACwJhthp7dYWbTutgz4",
            authDomain: "personal-564df.firebaseapp.com",
            projectId: "personal-564df",
            storageBucket: "personal-564df.firebasestorage.app",
            messagingSenderId: "1016556488732",
            appId: "1:1016556488732:web:06bf11f1be63a4242d77d9",
            
            // Firebase 활성화
            disabled: false // 실제 Firebase 프로젝트 연결됨
        };

        // Firebase 초기화 (조건부)
        let firebaseEnabled = false;
        
        if (!firebaseConfig.disabled && firebaseConfig.apiKey !== "AIzaSyDQGQGQGQGQGQGQGQGQGQGQGQGQGQGQG") {
            try {
                const app = initializeApp(firebaseConfig);
                const storage = getStorage(app);
                const firestore = getFirestore(app);

                // 전역에서 사용할 수 있도록 설정
                window.firebaseStorage = storage;
                window.firebaseFirestore = firestore;
                window.firebaseModules = {
                    ref, uploadBytes, getDownloadURL, deleteObject,
                    collection, addDoc, doc, deleteDoc, serverTimestamp
                };
                
                firebaseEnabled = true;
                console.log("🔥 Firebase v11.6.0 초기화 완료 (하이브리드 모드)");
            } catch (error) {
                console.warn("⚠️ Firebase 초기화 실패, 로컬 전용 모드로 전환:", error.message);
                firebaseEnabled = false;
            }
        } else {
            console.log("📱 로컬 전용 모드 (Firebase 비활성화)");
            firebaseEnabled = false;
        }
        
        // Firebase 상태를 전역에 저장
        window.firebaseEnabled = firebaseEnabled;
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .landlord-section .section-title {
            background: linear-gradient(135deg, #3742fa, #2f3542);
        }
        
        .tenant-section .section-title {
            background: linear-gradient(135deg, #5f27cd, #341f97);
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        
        .priority-stars {
            color: #ffc107;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .task-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .image-container {
            position: relative;
            min-height: 200px;
            background: #f8f9fa;
        }
        
        .carousel-container {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
        }
        
        .carousel-track {
            display: flex;
            transition: transform 0.3s ease;
            height: 100%;
        }
        
        .carousel-slide {
            min-width: 100%;
            height: 100%;
            position: relative;
        }
        
        .carousel-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .carousel-image:hover {
            transform: scale(1.02);
        }
        
        /* 🆕 저장 상태 아이콘 */
        .storage-status {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            z-index: 10;
        }
        
        .status-local {
            background: rgba(255, 152, 0, 0.9);
        }
        
        .status-cloud {
            background: rgba(76, 175, 80, 0.9);
        }
        
        .status-syncing {
            background: rgba(33, 150, 243, 0.9);
        }
        
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .carousel-nav:hover {
            background: rgba(0, 0, 0, 0.7);
        }
        
        .carousel-nav.prev {
            left: 10px;
        }
        
        .carousel-nav.next {
            right: 10px;
        }
        
        .no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #999;
            font-size: 14px;
        }
        
        .image-controls {
            padding: 15px 20px;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* 🆕 동기화 버튼 스타일 */
        .btn-sync {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            font-weight: bold;
        }
        
        .btn-sync:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
        }
        
        .btn-sync:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .image-counter {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
        }
        
        .delete-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .delete-btn:hover {
            background: rgba(220, 53, 69, 1);
        }
        
        .data-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .data-controls h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        /* 🆕 동기화 상태 표시 */
        .sync-status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }
        
        .sync-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .sync-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .sync-status.syncing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
        }
        
        .lightbox-content {
            position: relative;
            margin: auto;
            display: block;
            width: 90%;
            max-width: 900px;
            max-height: 80%;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .lightbox img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }
        
        .lightbox-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .lightbox-close:hover {
            color: #bbb;
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 20px 15px;
            cursor: pointer;
            font-size: 24px;
        }
        
        .lightbox-nav:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .lightbox-nav.prev {
            left: 20px;
        }
        
        .lightbox-nav.next {
            right: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .image-controls {
                justify-content: center;
            }
            
            .data-controls {
                padding: 15px;
            }
            
            .data-controls .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>부암동 건축 점검 보고서</h1>
        
        <!-- 🆕 향상된 데이터 관리 컨트롤 -->
        <div class="data-controls">
            <h3>📱 데이터 관리 (하이브리드 모드)</h3>
            
            <!-- 🆕 동기화 상태 표시 -->
            <div id="sync-status" class="sync-status disconnected">
                🔄 Firebase 연결 중...
            </div>
            
            <!-- 🆕 클라우드 동기화 버튼 -->
            <div style="margin-bottom: 15px;">
                <button class="btn btn-sync" id="sync-button" onclick="syncAllToCloud()">
                    ☁️ 로컬 데이터를 클라우드에 동기화
                </button>
                <button class="btn btn-secondary" onclick="checkSyncStatus()">
                    🔍 동기화 상태 확인
                </button>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="exportData()">💾 데이터 백업</button>
                <button class="btn btn-primary" onclick="importData()">📥 데이터 복원</button>
                <button class="btn btn-danger" onclick="clearAllData()">🗑️ 모든 데이터 삭제</button>
            </div>
            
            <div style="margin-top: 15px; font-size: 12px; color: #666;">
                <strong>📱 = 로컬 저장</strong> | <strong>☁️ = 클라우드 저장</strong> | <strong>🔄 = 동기화 중</strong><br>
                * 사진은 브라우저(LocalStorage) + Firebase Storage에 이중 저장됩니다.<br>
                * 오프라인에서도 작동하며, 온라인시 자동으로 클라우드 백업됩니다.
            </div>
        </div>        
        <!-- 임대인 협의사항 -->
        <div class="section landlord-section">
            <div class="section-title">👥 임대인 협의사항 (13개)</div>
            <div class="cards-grid">
                <!-- 1번 카드 -->
                <div class="card">
                    <div class="card-header">
                        <div class="priority-stars">⭐⭐⭐⭐⭐</div>
                        <h3 class="task-title">1번 건물외벽 곰팡이 청소</h3>
                    </div>
                    <div class="image-container">
                        <div id="carousel-1" class="carousel-container">
                            <div class="carousel-track">
                                <div class="carousel-slide">
                                    <div class="no-image">📷 현장 사진을 추가해주세요</div>
                                </div>
                            </div>
                        </div>
                        <button class="carousel-nav prev" onclick="prevImage('1')" style="display: none;">‹</button>
                        <button class="carousel-nav next" onclick="nextImage('1')" style="display: none;">›</button>
                    </div>
                    <div class="image-controls">
                        <div>
                            <button class="btn btn-primary" onclick="document.getElementById('file-input-1').click()">📷 사진 추가</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('camera-input-1').click()">📸 카메라</button>
                            <input type="file" id="file-input-1" class="file-input" accept="image/*" onchange="handleImageUpload(event, '1')">
                            <input type="file" id="camera-input-1" class="file-input" accept="image/*" capture="environment" onchange="handleImageUpload(event, '1')">
                        </div>
                        <div class="image-counter" id="counter-1">0/0</div>
                    </div>
                </div>

                <!-- 2번 카드 -->
                <div class="card">
                    <div class="card-header">
                        <div class="priority-stars">⭐⭐⭐⭐⭐</div>
                        <h3 class="task-title">2번 계단 난간 손잡이 설치</h3>
                    </div>
                    <div class="image-container">
                        <div id="carousel-2" class="carousel-container">
                            <div class="carousel-track">
                                <div class="carousel-slide">
                                    <div class="no-image">📷 현장 사진을 추가해주세요</div>
                                </div>
                            </div>
                        </div>
                        <button class="carousel-nav prev" onclick="prevImage('2')" style="display: none;">‹</button>
                        <button class="carousel-nav next" onclick="nextImage('2')" style="display: none;">›</button>
                    </div>
                    <div class="image-controls">
                        <div>
                            <button class="btn btn-primary" onclick="document.getElementById('file-input-2').click()">📷 사진 추가</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('camera-input-2').click()">📸 카메라</button>
                            <input type="file" id="file-input-2" class="file-input" accept="image/*" onchange="handleImageUpload(event, '2')">
                            <input type="file" id="camera-input-2" class="file-input" accept="image/*" capture="environment" onchange="handleImageUpload(event, '2')">
                        </div>
                        <div class="image-counter" id="counter-2">0/0</div>
                    </div>
                </div>

                <!-- 3번 카드 -->
                <div class="card">
                    <div class="card-header">
                        <div class="priority-stars">⭐⭐⭐⭐⭐</div>
                        <h3 class="task-title">3번 2층 화장실 천장 누수</h3>
                    </div>
                    <div class="image-container">
                        <div id="carousel-3" class="carousel-container">
                            <div class="carousel-track">
                                <div class="carousel-slide">
                                    <div class="no-image">📷 현장 사진을 추가해주세요</div>
                                </div>
                            </div>
                        </div>
                        <button class="carousel-nav prev" onclick="prevImage('3')" style="display: none;">‹</button>
                        <button class="carousel-nav next" onclick="nextImage('3')" style="display: none;">›</button>
                    </div>
                    <div class="image-controls">
                        <div>
                            <button class="btn btn-primary" onclick="document.getElementById('file-input-3').click()">📷 사진 추가</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('camera-input-3').click()">📸 카메라</button>
                            <input type="file" id="file-input-3" class="file-input" accept="image/*" onchange="handleImageUpload(event, '3')">
                            <input type="file" id="camera-input-3" class="file-input" accept="image/*" capture="environment" onchange="handleImageUpload(event, '3')">
                        </div>
                        <div class="image-counter" id="counter-3">0/0</div>
                    </div>
                </div>
                <!-- 4-14번 카드들 -->
                <div class="card">
                    <div class="card-header">
                        <div class="priority-stars">⭐⭐⭐⭐⭐</div>
                        <h3 class="task-title">4번 1층 바닥 보수</h3>
                    </div>
                    <div class="image-container">
                        <div id="carousel-4" class="carousel-container">
                            <div class="carousel-track">
                                <div class="carousel-slide">
                                    <div class="no-image">📷 현장 사진을 추가해주세요</div>
                                </div>
                            </div>
                        </div>
                        <button class="carousel-nav prev" onclick="prevImage('4')" style="display: none;">‹</button>
                        <button class="carousel-nav next" onclick="nextImage('4')" style="display: none;">›</button>
                    </div>
                    <div class="image-controls">
                        <div>
                            <button class="btn btn-primary" onclick="document.getElementById('file-input-4').click()">📷 사진 추가</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('camera-input-4').click()">📸 카메라</button>
                            <input type="file" id="file-input-4" class="file-input" accept="image/*" onchange="handleImageUpload(event, '4')">
                            <input type="file" id="camera-input-4" class="file-input" accept="image/*" capture="environment" onchange="handleImageUpload(event, '4')">
                        </div>
                        <div class="image-counter" id="counter-4">0/0</div>
                    </div>
                </div>

                <!-- 나머지 카드들 5-13번 (간소화) -->
                <div class="card"><div class="card-header"><div class="priority-stars">⭐⭐⭐⭐⭐</div><h3 class="task-title">5번 2층 바닥 보수</h3></div><div class="image-container"><div id="carousel-5" class="carousel-container"><div class="carousel-track"><div class="carousel-slide"><div class="no-image">📷 현장 사진을 추가해주세요</div></div></div></div><button class="carousel-nav prev" onclick="prevImage('5')" style="display: none;">‹</button><button class="carousel-nav next" onclick="nextImage('5')" style="display: none;">›</button></div><div class="image-controls"><div><button class="btn btn-primary" onclick="document.getElementById('file-input-5').click()">📷 사진 추가</button><button class="btn btn-secondary" onclick="document.getElementById('camera-input-5').click()">📸 카메라</button><input type="file" id="file-input-5" class="file-input" accept="image/*" onchange="handleImageUpload(event, '5')"><input type="file" id="camera-input-5" class="file-input" accept="image/*" capture="environment" onchange="handleImageUpload(event, '5')"></div><div class="image-counter" id="counter-5">0/0</div></div></div>

                <div class="card"><div class="card-header"><div class="priority-stars">⭐⭐⭐⭐</div><h3 class="task-title">6번 4층 화장실 바닥 누수</h3></div><div class="image-container"><div id="carousel-6" class="carousel-container"><div class="carousel-track"><div class="carousel-slide"><div class="no-image">📷 현장 사진을 추가해주세요</div></div></div></div><button class="carousel-nav prev" onclick="prevImage('6')" style="display: none;">‹</button><button class="carousel-nav next" onclick="nextImage('6')" style="display: none;">›</button></div><div class="image-controls"><div><button class="btn btn-primary" onclick="document.getElementById('file-input-6').click()">📷 사진 추가</button><button class="btn btn-secondary" onclick="document.getElementById('camera-input-6').click()">📸 카메라</button><input type="file" id="file-input-6" class="file-input" accept="image/*" onchange="handleImageUpload(event, '6')"><input type="file" id="camera-input-6" class="file-input" accept="image/*" capture="environment" onchange="handleImageUpload(event, '6')"></div><div class="image-counter" id="counter-6">0/0</div></div></div>

                <div class="card"><div class="card-header"><div class="priority-stars">⭐⭐⭐⭐</div><h3 class="task-title">7번 조경 정리</h3></div><div class="image-container"><div id="carousel-7" class="carousel-container"><div class="carousel-track"><div class="carousel-slide"><div class="no-image">📷 현장 사진을 추가해주세요</div></div></div></div><button class="carousel-nav prev" onclick="prevImage('7')" style="display: none;">‹</button><button class="carousel-nav next" onclick="nextImage('7')" style="display: none;">›</button></div><div class="image-controls"><div><button class="btn btn-primary" onclick="document.getElementById('file-input-7').click()">📷 사진 추가</button><button class="btn btn-secondary" onclick="document.getElementById('camera-input-7').click()">📸 카메라</button><input type="file" id="file-input-7" class="file-input" accept="image/*" onchange="handleImageUpload(event, '7')"><input type="file" id="camera-input-7" class="file-input" accept="image/*" capture="environment" onchange="handleImageUpload(event, '7')"></div><div class="image-counter" id="counter-7">0/0</div></div></div>
            </div>
        </div>

        <!-- 전임차인 협의사항 -->
        <div class="section tenant-section">
            <div class="section-title">🏪 전임차인 협의사항 (1개)</div>
            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="priority-stars">⭐</div>
                        <h3 class="task-title">14번 카페 바테이블 처리</h3>
                    </div>
                    <div class="image-container">
                        <div id="carousel-14" class="carousel-container">
                            <div class="carousel-track">
                                <div class="carousel-slide">
                                    <div class="no-image">📷 현장 사진을 추가해주세요</div>
                                </div>
                            </div>
                        </div>
                        <button class="carousel-nav prev" onclick="prevImage('14')" style="display: none;">‹</button>
                        <button class="carousel-nav next" onclick="nextImage('14')" style="display: none;">›</button>
                    </div>
                    <div class="image-controls">
                        <div>
                            <button class="btn btn-primary" onclick="document.getElementById('file-input-14').click()">📷 사진 추가</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('camera-input-14').click()">📸 카메라</button>
                            <input type="file" id="file-input-14" class="file-input" accept="image/*" onchange="handleImageUpload(event, '14')">
                            <input type="file" id="camera-input-14" class="file-input" accept="image/*" capture="environment" onchange="handleImageUpload(event, '14')">
                        </div>
                        <div class="image-counter" id="counter-14">0/0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <button class="lightbox-nav prev" onclick="event.stopPropagation(); prevLightboxImage()">‹</button>
        <button class="lightbox-nav next" onclick="event.stopPropagation(); nextLightboxImage()">›</button>
        <div class="lightbox-content">
            <img id="lightbox-image" src="" alt="">
        </div>
    </div>

    <script>
        // 전역 변수
        let allCarousels = {};
        let currentCarousel = null;
        let currentImageIndex = 0;
        let lightboxImages = [];
        let currentLightboxIndex = 0;

        // 🆕 동기화 상태 관리
        let syncStatus = {
            connected: false,
            syncing: false,
            lastSync: null
        };

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            updateFirebaseStatus();
            loadInitialImages();
            initializeCarousels();
            checkStorageQuota();
            
            // 🆕 동기화 상태 체크
            setTimeout(checkSyncStatus, 2000);
        }

        function updateFirebaseStatus() {
            const statusElement = document.getElementById('sync-status');
            const syncButton = document.getElementById('sync-button');
            
            if (window.firebaseEnabled) {
                statusElement.innerHTML = '☁️ Firebase 연결됨 - 하이브리드 모드 활성';
                statusElement.className = 'sync-status connected';
                syncButton.disabled = false;
                syncStatus.connected = true;
            } else {
                statusElement.innerHTML = '📱 로컬 전용 모드 - Firebase 연결 실패';
                statusElement.className = 'sync-status disconnected';
                syncButton.disabled = true;
                syncStatus.connected = false;
            }
        }

        // 🆕 클라우드 동기화 함수
        async function syncAllToCloud() {
            if (!window.firebaseEnabled) {
                alert('⚠️ Firebase 연결이 필요합니다.');
                return;
            }

            const syncButton = document.getElementById('sync-button');
            const statusElement = document.getElementById('sync-status');
            
            syncButton.disabled = true;
            syncButton.innerHTML = '🔄 동기화 중...';
            statusElement.innerHTML = '🔄 클라우드 동기화 진행 중...';
            statusElement.className = 'sync-status syncing';
            syncStatus.syncing = true;

            try {
                let syncCount = 0;
                
                // 모든 카드의 이미지 동기화
                for (let cardId = 1; cardId <= 14; cardId++) {
                    const images = JSON.parse(localStorage.getItem(`carousel-images-${cardId}`) || '[]');
                    
                    for (let i = 0; i < images.length; i++) {
                        const imageData = images[i];
                        
                        // 로컬에만 있는 이미지 찾기 (firebaseUrl이 없는 경우)
                        if (!imageData.firebaseUrl && imageData.dataUrl) {
                            try {
                                const firebaseUrl = await uploadToFirebase(imageData.dataUrl, `card-${cardId}-${Date.now()}-${i}.jpg`);
                                imageData.firebaseUrl = firebaseUrl;
                                imageData.synced = true;
                                syncCount++;
                                
                                console.log(`✅ 카드 ${cardId} 이미지 ${i+1} 동기화 완료`);
                            } catch (error) {
                                console.error(`❌ 카드 ${cardId} 이미지 ${i+1} 동기화 실패:`, error);
                            }
                        }
                    }
                    
                    // 업데이트된 이미지 데이터 저장
                    localStorage.setItem(`carousel-images-${cardId}`, JSON.stringify(images));
                    updateStorageStatus(cardId);
                }

                syncStatus.lastSync = new Date().toLocaleString();
                statusElement.innerHTML = `☁️ 동기화 완료 (${syncCount}개 이미지) - ${syncStatus.lastSync}`;
                statusElement.className = 'sync-status connected';
                
                // 모든 카드의 저장 상태 아이콘 업데이트
                for (let cardId = 1; cardId <= 14; cardId++) {
                    updateStorageStatus(cardId);
                }

            } catch (error) {
                console.error('동기화 실패:', error);
                statusElement.innerHTML = '❌ 동기화 실패 - 다시 시도해주세요';
                statusElement.className = 'sync-status disconnected';
            } finally {
                syncButton.disabled = false;
                syncButton.innerHTML = '☁️ 로컬 데이터를 클라우드에 동기화';
                syncStatus.syncing = false;
            }
        }
        // 🆕 동기화 상태 확인
        async function checkSyncStatus() {
            const statusElement = document.getElementById('sync-status');
            
            if (!window.firebaseEnabled) {
                alert('📱 현재 로컬 전용 모드입니다.\n\n모든 이미지가 브라우저에만 저장되어 있습니다.');
                return;
            }

            let totalImages = 0;
            let syncedImages = 0;
            let localOnlyImages = 0;

            for (let cardId = 1; cardId <= 14; cardId++) {
                const images = JSON.parse(localStorage.getItem(`carousel-images-${cardId}`) || '[]');
                totalImages += images.length;
                
                images.forEach(img => {
                    if (img.firebaseUrl) {
                        syncedImages++;
                    } else {
                        localOnlyImages++;
                    }
                });
            }

            const message = `📊 동기화 상태 확인 결과:\n\n` +
                           `• 전체 이미지: ${totalImages}개\n` +
                           `• ☁️ 클라우드 동기화: ${syncedImages}개\n` +
                           `• 📱 로컬 전용: ${localOnlyImages}개\n\n` +
                           `${localOnlyImages > 0 ? '💡 "클라우드 동기화" 버튼으로 로컬 이미지를 업로드하세요!' : '✅ 모든 이미지가 동기화되어 있습니다!'}`;
            
            alert(message);
        }

        // 🆕 저장 상태 아이콘 업데이트
        function updateStorageStatus(cardId) {
            const carousel = document.getElementById(`carousel-${cardId}`);
            const images = JSON.parse(localStorage.getItem(`carousel-images-${cardId}`) || '[]');
            
            // 기존 상태 아이콘 제거
            const existingStatus = carousel.querySelectorAll('.storage-status');
            existingStatus.forEach(status => status.remove());
            
            // 현재 표시된 이미지의 상태 확인
            const currentIndex = allCarousels[cardId]?.currentIndex || 0;
            if (images.length > 0 && images[currentIndex]) {
                const currentImage = images[currentIndex];
                const imageElement = carousel.querySelector('.carousel-slide img');
                
                if (imageElement) {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'storage-status';
                    
                    if (syncStatus.syncing) {
                        statusDiv.className += ' status-syncing';
                        statusDiv.innerHTML = '🔄 동기화중';
                    } else if (currentImage.firebaseUrl) {
                        statusDiv.className += ' status-cloud';
                        statusDiv.innerHTML = '☁️ 클라우드';
                    } else {
                        statusDiv.className += ' status-local';
                        statusDiv.innerHTML = '📱 로컬';
                    }
                    
                    imageElement.parentElement.appendChild(statusDiv);
                }
            }
        }

        // 이미지 업로드 처리 (개선됨)
        async function handleImageUpload(event, cardId) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                // 파일 크기 체크 (10MB 제한)
                if (file.size > 10 * 1024 * 1024) {
                    alert('⚠️ 파일 크기가 10MB를 초과합니다.');
                    return;
                }

                console.log(`📷 이미지 업로드 시작: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);

                // 이미지 압축
                const compressedDataUrl = await compressImage(file);
                console.log(`🗜️ 압축 완료: ${((compressedDataUrl.length * 0.75) / 1024 / 1024).toFixed(2)}MB`);

                // 새 이미지 데이터 생성
                const newImageData = {
                    dataUrl: compressedDataUrl,
                    filename: file.name,
                    timestamp: Date.now(),
                    size: compressedDataUrl.length,
                    compressed: true,
                    synced: false
                };

                // Firebase Storage에 업로드 시도 (하이브리드 모드)
                if (window.firebaseEnabled) {
                    try {
                        const firebaseUrl = await uploadToFirebase(compressedDataUrl, `card-${cardId}-${Date.now()}.jpg`);
                        newImageData.firebaseUrl = firebaseUrl;
                        newImageData.synced = true;
                        console.log('☁️ Firebase Storage 업로드 성공');
                    } catch (error) {
                        console.warn('⚠️ Firebase 업로드 실패, 로컬 저장만 진행:', error.message);
                    }
                }

                // LocalStorage에 저장
                addImageToCarousel(cardId, newImageData);
                
                // 저장 상태 아이콘 업데이트
                setTimeout(() => updateStorageStatus(cardId), 100);

                // 스토리지 사용량 체크
                checkStorageQuota();

            } catch (error) {
                console.error('이미지 업로드 실패:', error);
                alert('❌ 이미지 업로드에 실패했습니다: ' + error.message);
            }

            // 파일 입력 초기화
            event.target.value = '';
        }
        // Firebase Storage 업로드 함수
        async function uploadToFirebase(dataUrl, filename) {
            if (!window.firebaseEnabled) {
                throw new Error('Firebase가 활성화되지 않음');
            }

            try {
                const response = await fetch(dataUrl);
                const blob = await response.blob();
                
                const { ref, uploadBytes, getDownloadURL } = window.firebaseModules;
                const storageRef = ref(window.firebaseStorage, `images/${filename}`);
                
                const snapshot = await uploadBytes(storageRef, blob);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                return downloadURL;
            } catch (error) {
                console.error('Firebase 업로드 오류:', error);
                throw error;
            }
        }

        // 이미지 압축 함수
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // 캐러셀에 이미지 추가
        function addImageToCarousel(cardId, newImageData) {
            try {
                const images = JSON.parse(localStorage.getItem(`carousel-images-${cardId}`) || '[]');
                images.push(newImageData);
                localStorage.setItem(`carousel-images-${cardId}`, JSON.stringify(images));

                if (!allCarousels[cardId]) {
                    allCarousels[cardId] = { images: [], currentIndex: 0 };
                }
                allCarousels[cardId].images = images;

                renderCarousel(cardId);
                updateImageCounter(cardId);

                console.log(`✅ 카드 ${cardId}에 이미지 추가됨 (총 ${images.length}개)`);

            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    handleStorageQuotaExceeded(cardId);
                } else {
                    throw error;
                }
            }
        }

        // 캐러셀 렌더링
        function renderCarousel(cardId) {
            const carousel = allCarousels[cardId];
            if (!carousel || carousel.images.length === 0) {
                return;
            }

            const carouselContainer = document.getElementById(`carousel-${cardId}`);
            const track = carouselContainer.querySelector('.carousel-track');
            
            track.innerHTML = '';

            carousel.images.forEach((imageData, index) => {
                const slide = document.createElement('div');
                slide.className = 'carousel-slide';
                
                const img = document.createElement('img');
                img.src = imageData.dataUrl;
                img.className = 'carousel-image';
                img.onclick = () => openLightbox(cardId, index);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteImage(cardId, index);
                };
                
                slide.appendChild(img);
                slide.appendChild(deleteBtn);
                track.appendChild(slide);
            });

            updateCarouselPosition(cardId);
            
            const prevBtn = carouselContainer.parentElement.querySelector('.carousel-nav.prev');
            const nextBtn = carouselContainer.parentElement.querySelector('.carousel-nav.next');
            
            if (carousel.images.length > 1) {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            }

            // 저장 상태 아이콘 업데이트
            setTimeout(() => updateStorageStatus(cardId), 100);
        }

        // 캐러셀 위치 업데이트
        function updateCarouselPosition(cardId) {
            const carousel = allCarousels[cardId];
            if (!carousel) return;

            const track = document.querySelector(`#carousel-${cardId} .carousel-track`);
            const translateX = -carousel.currentIndex * 100;
            track.style.transform = `translateX(${translateX}%)`;
        }

        // 이미지 카운터 업데이트
        function updateImageCounter(cardId) {
            const counter = document.getElementById(`counter-${cardId}`);
            const carousel = allCarousels[cardId];
            
            if (carousel && carousel.images.length > 0) {
                counter.textContent = `${carousel.currentIndex + 1}/${carousel.images.length}`;
            } else {
                counter.textContent = '0/0';
            }
        }